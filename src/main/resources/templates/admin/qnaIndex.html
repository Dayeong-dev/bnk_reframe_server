<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>1:1ë¬¸ì˜ ê´€ë¦¬</title>
<link rel="stylesheet" th:href="@{/admin/css/header.css}" />
<link rel="stylesheet" th:href="@{/admin/css/sidebar.css}" />
<link rel="stylesheet" th:href="@{/admin/css/base.css}" />
<style>
table {
	width: 100%;
	border-collapse: collapse;
}

table, th, td {
	border: 1px solid #ccc;
}

th, td {
	padding: 10px;
	text-align: left;
}

.pagination {
	margin-top: 15px;
	text-align: center;
}

.pagination button {
	margin: 0 5px;
	padding: 5px 10px;
}

.hidden {
	display: none;
}

#qna-form {
	display: none;
}

#qna-detail {
	display: none;
}
</style>
</head>
<body>

	<!-- ê³µí†µ í—¤ë” -->
	<div th:replace="admin/fragments/header :: header" class="header"></div>

	<div id="body">
		<!-- ì‚¬ì´ë“œë°” -->
		<div th:replace="admin/fragments/sidebar :: sidebar" class="sidebar"></div>

		<!-- ë³¸ë¬¸ -->



		<div class="content" id="main-content">
			<h1>1:1 ë¬¸ì˜ ê´€ë¦¬</h1>

			<div id="alert-banner" style="display: none;">
				ğŸš¨ ë¶€ì • ë¦¬ë·°ê°€ <span id="alert-count"></span>ê±´ ìˆìŠµë‹ˆë‹¤!
			</div>


			<div id="qna-list" th:if="${qnalist != null}">
				<table>
					<thead>
						<tr>
							<th>ê¸€ë²ˆí˜¸</th>
							<th>ì œëª©</th>
							<th>ì‘ì„±ì</th>
							<th>ì‘ì„±ì¼</th>
							<th>ë‹µë³€ì¼</th>
							<th>ì¹´í…Œê³ ë¦¬</th>
							<th>ìƒíƒœ</th>
						</tr>
					</thead>
					<tbody id="qna-tbody">
						<tr th:each="qna : ${qnalist}">
							<td th:text="${qna.qnaId}"></td>
							<td><a href="#" th:attr="data-id=${qna.qnaId}"
								th:text="${qna.title}"
								onclick="loadQnaDetail(this); return false;"></a></td>
							<td th:text="${qna.username}"></td>
							<td
								th:text="${#temporals.format(qna.regdate, 'yyyy-MM-dd HH:mm')}"></td>
							<td
								th:text="${#temporals.format(qna.moddate, 'yyyy-MM-dd HH:mm')}"></td>
							<td th:text="${qna.category}"></td>
							<td th:text="${qna.status}"></td>
						</tr>
					</tbody>

				</table>

				<!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
				<div class="pagination" id="pagination"></div>
			</div>



			<hr>

			<div id="qna-detail">

				<p>
					<strong>ê¸€ë²ˆí˜¸:</strong> <span id="detail-id"></span>
				</p>
				<p>
					<strong>ì œëª©:</strong> <span id="detail-title"></span>
				</p>
				<p>
					<strong>ì‘ì„±ì:</strong> <span id="detail-username"></span>
				</p>
				<p>
					<strong>ì‘ì„±ì¼:</strong> <span id="detail-regdate"></span>
				</p>



				<p>
					<strong>ì¹´í…Œê³ ë¦¬:</strong> <span id="detail-category"></span>
				</p>
				<p>
					<strong>ìƒíƒœ:</strong> <span id="detail-status"></span>
				</p>
				<hr>
				<p>
					<strong>ë‚´ìš©:</strong><span class="content-box" id="detail-content"></span>
				</p>

				<hr>
				<p>
					<strong>ë‹µë³€:</strong>
				</p>
				<textarea id="detail-answer" rows="5" style="width: 100%;"></textarea>
				<br />
				<button onclick="submitAnswer()">ë‹µë³€ ë“±ë¡</button>
			</div>
		</div>
	</div>

	<script>
  const rowsPerPage = 5;
  let currentCategory = "ì „ì²´";
  let currentPage = 0;
  let allRows = [];
  let filteredRows = [];

  document.addEventListener("DOMContentLoaded", () => {
    allRows = Array.from(document.querySelectorAll("#qna-tbody tr"));
    initCategoryFilter();
    showPage(0);

    // ìƒì„¸ë³´ê¸° ë° ë‹µë³€ ë“±ë¡ í•¨ìˆ˜ ì™¸ë¶€ì—ì„œë„ ì ‘ê·¼ ê°€ëŠ¥
    window.loadQnaDetail = loadQnaDetail;
    window.submitAnswer = submitAnswer;
  });

  function initCategoryFilter() {
    const container = document.createElement("div");
    container.id = "category-buttons";
    container.style.margin = "10px 0";

    const uniqueCategories = [...new Set(allRows.map(row =>
      row.querySelector("td:nth-child(6)").textContent.trim()
    ))];

    ["ì „ì²´", ...uniqueCategories].forEach(category => {
      const btn = document.createElement("button");
      btn.textContent = category;
      btn.className = "category-btn";
      if (category === currentCategory) btn.classList.add("active");
      btn.addEventListener("click", () => {
        document.querySelectorAll(".category-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentCategory = category;
        filterRows();
        showPage(0);
        renderPagination();
      });
      container.appendChild(btn);
    });

    const listSection = document.getElementById("qna-list");
    listSection.insertBefore(container, listSection.firstChild);

    filterRows();
    renderPagination();
  }

  function filterRows() {
    filteredRows = allRows.filter(row => {
      const cat = row.querySelector("td:nth-child(6)").textContent.trim();
      return currentCategory === "ì „ì²´" || cat === currentCategory;
    });
  }

  function showPage(page) {
    allRows.forEach(row => row.classList.add("hidden"));
    filteredRows.forEach((row, index) => {
      row.classList.toggle("hidden", index < page * rowsPerPage || index >= (page + 1) * rowsPerPage);
    });
    currentPage = page;
  }

  function renderPagination() {
    const pagination = document.getElementById("pagination");
    pagination.innerHTML = "";

    const pageCount = Math.ceil(filteredRows.length / rowsPerPage);

    for (let i = 0; i < pageCount; i++) {
      const btn = document.createElement("button");
      btn.textContent = i + 1;
      btn.addEventListener("click", () => showPage(i));
      pagination.appendChild(btn);
    }
  }

  function loadQnaDetail(element) {
	  const qnaId = element.getAttribute('data-id');

	  fetch('/admin/qnaDetail/' + qnaId)
	    .then(response => response.json())
	    .then(qna => {
	      document.getElementById("detail-id").textContent = qna.qnaId;
	      document.getElementById("detail-title").textContent = qna.title;
	      document.getElementById("detail-username").textContent = qna.username;
	      document.getElementById("detail-regdate").textContent = qna.regdate;
	      document.getElementById("detail-category").textContent = qna.category;
	      document.getElementById("detail-status").textContent = qna.status;
	      document.getElementById("detail-content").textContent = qna.content;
	      document.getElementById("detail-answer").value = qna.answer;

	      //ìƒì„¸ë³´ê¸° í¼ ë³´ì´ê¸°
	      document.getElementById("qna-detail").style.display = "block";

	      //ìŠ¤í¬ë¡¤ ì´ë™ (ì„ íƒ)
	      document.getElementById("qna-detail").scrollIntoView({ behavior: "smooth" });
	    })
	    .catch(error => {
	      console.error("QNA ìƒì„¸ë³´ê¸° ì‹¤íŒ¨:", error);
	      alert("ìƒì„¸ë³´ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
	    });
	}


  function submitAnswer() {
    const qnaId = document.getElementById("detail-id").textContent;
    const answer = document.getElementById("detail-answer").value;

    if (!answer.trim()) {
      alert("ë‹µë³€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }

    fetch('/admin/submitAnswer', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ qnaId, answer })
    })
      .then(response => {
        if (!response.ok) throw new Error('ì„œë²„ ì˜¤ë¥˜');
        return response.json();
      })
      .then(updatedQna => {
        alert("ë‹µë³€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
        document.getElementById("detail-answer").value = updatedQna.answer;
        document.getElementById("detail-status").textContent = updatedQna.status;

        // í…Œì´ë¸” ë°˜ì˜
        const row = document.querySelector(`a[data-id="${qnaId}"]`).closest("tr");
        row.querySelector("td:nth-child(7)").textContent = updatedQna.status;
        row.querySelector("td:nth-child(6)").textContent = updatedQna.category;
      })
      .catch(error => {
        console.error("ë‹µë³€ ë“±ë¡ ì‹¤íŒ¨:", error);
        alert("ë‹µë³€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      });
  }
  
  fetch('/admin/alertCount')
  .then(res => res.json())
  .then(count => {
    if (count > 0) {
      const banner = document.getElementById("alert-banner");
      const countSpan = document.getElementById("alert-count");
      countSpan.textContent = count;
      banner.style.display = "block";

      // ìë™ ì‚¬ë¼ì§
      setTimeout(() => {
        banner.style.display = "none";
      }, 10000);

      
    }
  });
</script>


</body>
</html>
