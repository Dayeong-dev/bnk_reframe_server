<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>1:1ë¬¸ì˜ ê´€ë¦¬</title>
<link rel="stylesheet" th:href="@{/admin/css/header.css}" />
<link rel="stylesheet" th:href="@{/admin/css/sidebar.css}" />
<link rel="stylesheet" th:href="@{/admin/css/base.css}" />
<style>
	/* ë¦¬íŒ©í† ë§ëœ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
	.top-menu {
		display: flex;
		align-items: center;
		gap: 0;
		margin-bottom: 20px;
	}

	.menu-btn {
		height: 40px;
		padding: 0 20px;
		background-color: #f8f9fa;
		color: #495057;
		border: 1px solid #dee2e6;
		border-right: none;
		font-size: 14px;
		font-weight: 500;
		cursor: pointer;
		transition: all 0.2s ease;
		white-space: nowrap;
	}

	.menu-btn:first-child {
		border-top-left-radius: 6px;
		border-bottom-left-radius: 6px;
	}
	
	.menu-btn:last-child {
		border-right: 1px solid #dee2e6;
		border-top-right-radius: 6px;
		border-bottom-right-radius: 6px;
	}

	.menu-btn:hover {
		background-color: #e9ecef;
		color: #212529;
	}

	.menu-btn.active {
		background-color: #007bff;
		color: white;
		border-color: #007bff;
	}

	.menu-btn.active:hover {
		background-color: #0056b3;
	}

	/* ì•Œë¦¼ ë°°ë„ˆ ìŠ¤íƒ€ì¼ */
	#alert-banner {
		background-color: #fff3cd;
		border: 1px solid #ffeaa7;
		border-radius: 6px;
		padding: 12px 16px;
		margin-bottom: 20px;
		color: #856404;
		font-size: 14px;
		font-weight: 500;
		box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
	}

	/* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
	table {
		border-collapse: collapse;
		width: 100%;
		font-size: 14px;
		background-color: white;
		border-radius: 6px;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
	}

	table th,
	table td {
		border: 1px solid #dee2e6;
		padding: 12px 16px;
		text-align: left;
	}

	table th {
		background-color: #f8f9fa;
		font-weight: 600;
		color: #495057;
	}

	table td a {
		color: #007bff;
		text-decoration: none;
		font-weight: 500;
	}

	table td a:hover {
		text-decoration: underline;
		color: #0056b3;
	}

	/* í˜ì´ì§€ë„¤ì´ì…˜ ìŠ¤íƒ€ì¼ */
	.pagination {
		margin-top: 20px;
		text-align: center;
	}

	.pagination button {
		height: 36px;
		padding: 0 12px;
		margin: 0 2px;
		background-color: #f8f9fa;
		color: #495057;
		border: 1px solid #dee2e6;
		border-radius: 4px;
		font-size: 14px;
		font-weight: 500;
		cursor: pointer;
		transition: all 0.2s ease;
	}

	.pagination button:hover {
		background-color: #e9ecef;
		color: #212529;
	}

	.pagination button.active {
		background-color: #007bff;
		color: white;
		border-color: #007bff;
	}

	/* ìƒì„¸ ë³´ê¸° ìŠ¤íƒ€ì¼ */
	.detail-section {
		margin-top: 20px;
		background-color: #fff;
		padding: 24px;
		border: 1px solid #dee2e6;
		border-radius: 8px;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
	}

	.detail-section p {
		margin: 12px 0;
		font-size: 14px;
		color: #495057;
	}

	.detail-section strong {
		font-weight: 600;
		color: #212529;
	}

	.detail-section .content-box {
		background-color: #f8f9fa;
		padding: 16px;
		border: 1px solid #dee2e6;
		border-radius: 4px;
		margin-top: 8px;
		white-space: pre-wrap;
		line-height: 1.5;
		display: block;
		margin-left: 8px;
	}

	.detail-section textarea {
		width: 100%;
		padding: 12px;
		margin: 8px 0;
		font-size: 14px;
		border: 1px solid #ced4da;
		border-radius: 4px;
		background-color: white;
		resize: vertical;
	}

	.detail-section button {
		padding: 12px 24px;
		margin-top: 15px;
		background-color: #007bff;
		color: white;
		border: none;
		border-radius: 4px;
		font-weight: 500;
		cursor: pointer;
		transition: all 0.2s ease;
	}

	.detail-section button:hover {
		background-color: #0056b3;
	}

	/* í˜ì´ì§€ ì œëª© ìŠ¤íƒ€ì¼ */
	h1 {
		color: #212529;
		font-size: 24px;
		font-weight: 600;
		margin-bottom: 24px;
		padding-bottom: 12px;
		border-bottom: 2px solid #dee2e6;
	}

	/* ìˆ¨ê¹€ ì²˜ë¦¬ */
	.hidden {
		display: none;
	}

	#qna-form, #qna-detail {
		display: none;
	}

	/* êµ¬ë¶„ì„  ìŠ¤íƒ€ì¼ */
	hr {
		margin: 24px 0;
		border: none;
		border-top: 1px solid #dee2e6;
	}

	/* ë°˜ì‘í˜• ë””ìì¸ */
	@media (max-width: 768px) {
		.top-menu {
			flex-wrap: wrap;
			gap: 10px;
		}
		
		.menu-btn {
			border-radius: 4px;
			border: 1px solid #dee2e6;
		}
	}
</style>
</head>
<body>

	<!-- ê³µí†µ í—¤ë” -->
	<div th:replace="admin/fragments/header :: header" class="header"></div>

	<div id="body">
		<!-- ì‚¬ì´ë“œë°” -->
		<div th:replace="admin/fragments/sidebar :: sidebar" class="sidebar"></div>

		<!-- ë³¸ë¬¸ -->
		<div class="content" id="main-content">
			<h1>1:1 ë¬¸ì˜ ê´€ë¦¬</h1>

			<div id="alert-banner" style="display: none;">
				ğŸš¨ ë¶€ì • ë¦¬ë·°ê°€ <span id="alert-count"></span>ê±´ ìˆìŠµë‹ˆë‹¤!
			</div>

			<!-- ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ ì˜ì—­ -->
			<div class="top-menu" id="category-buttons">
				<!-- ë²„íŠ¼ì€ JSë¡œ ìƒì„± -->
			</div>

			<div id="qna-list" th:if="${qnalist != null}">
				<table id="qna-table">
					<thead>
						<tr>
							<th>ê¸€ë²ˆí˜¸</th>
							<th>ì œëª©</th>
							<th>ì‘ì„±ì</th>
							<th>ì‘ì„±ì¼</th>
							<th>ë‹µë³€ì¼</th>
							<th>ì¹´í…Œê³ ë¦¬</th>
							<th>ìƒíƒœ</th>
						</tr>
					</thead>
					<tbody id="qna-tbody">
						<tr th:each="qna : ${qnalist}">
							<td th:text="${qna.qnaId}"></td>
							<td><a href="#" th:attr="data-id=${qna.qnaId}"
								th:text="${qna.title}"
								onclick="loadQnaDetail(this); return false;"></a></td>
							<td th:text="${qna.username}"></td>
							<td
								th:text="${#temporals.format(qna.regdate, 'yyyy-MM-dd HH:mm')}"></td>
							<td
								th:text="${#temporals.format(qna.moddate, 'yyyy-MM-dd HH:mm')}"></td>
							<td th:text="${qna.category}"></td>
							<td th:text="${qna.status}"></td>
						</tr>
					</tbody>
				</table>

				<!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
				<div class="pagination" id="pagination"></div>
			</div>

			<hr>

			<div id="qna-detail" class="detail-section">
				<p>
					<strong>ê¸€ë²ˆí˜¸:</strong> <span id="detail-id"></span>
				</p>
				<p>
					<strong>ì œëª©:</strong> <span id="detail-title"></span>
				</p>
				<p>
					<strong>ì‘ì„±ì:</strong> <span id="detail-username"></span>
				</p>
				<p>
					<strong>ì‘ì„±ì¼:</strong> <span id="detail-regdate"></span>
				</p>
				<p>
					<strong>ì¹´í…Œê³ ë¦¬:</strong> <span id="detail-category"></span>
				</p>
				<p>
					<strong>ìƒíƒœ:</strong> <span id="detail-status"></span>
				</p>
				
				<hr>
				<p>
					<strong>ë‚´ìš©:</strong>
				</p>
				<div class="content-box" id="detail-content"></div>
				
				<hr>
				<p>
					<strong>ë‹µë³€:</strong>
				</p>
				<textarea id="detail-answer" rows="5"></textarea>
				<button onclick="submitAnswer()">ë‹µë³€ ë“±ë¡</button>
			</div>
		</div>
	</div>

	<script>
		const rowsPerPage = 5;
		let currentCategory = "ì „ì²´";
		let currentPage = 0;
		let allRows = [];
		let filteredRows = [];

		document.addEventListener("DOMContentLoaded", () => {
			allRows = Array.from(document.querySelectorAll("#qna-tbody tr"));
			initCategoryFilter();
			renderPagination();
			showPage(0);

			// ìƒì„¸ë³´ê¸° ë° ë‹µë³€ ë“±ë¡ í•¨ìˆ˜ ì™¸ë¶€ì—ì„œë„ ì ‘ê·¼ ê°€ëŠ¥
			window.loadQnaDetail = loadQnaDetail;
			window.submitAnswer = submitAnswer;
		});

		function initCategoryFilter() {
			const container = document.getElementById("category-buttons");

			const uniqueCategories = [...new Set(allRows.map(row =>
				row.querySelector("td:nth-child(6)").textContent.trim()
			))];

			["ì „ì²´", ...uniqueCategories].forEach(category => {
				const btn = document.createElement("button");
				btn.textContent = category;
				btn.className = "menu-btn";
				btn.dataset.category = category;
				
				if (category === currentCategory) btn.classList.add("active");
				
				btn.addEventListener("click", () => {
					document.querySelectorAll(".menu-btn").forEach(b => b.classList.remove("active"));
					btn.classList.add("active");
					currentCategory = category;
					filterRows();
					showPage(0);
					renderPagination();
				});
				
				container.appendChild(btn);
			});

			filterRows();
		}

		function filterRows() {
			filteredRows = allRows.filter(row => {
				const cat = row.querySelector("td:nth-child(6)").textContent.trim();
				return currentCategory === "ì „ì²´" || cat === currentCategory;
			});
		}

		function showPage(page) {
			allRows.forEach(row => row.classList.add("hidden"));
			filteredRows.forEach((row, index) => {
				row.classList.toggle("hidden", index < page * rowsPerPage || index >= (page + 1) * rowsPerPage);
			});
			currentPage = page;
		}

		function renderPagination() {
			const pagination = document.getElementById("pagination");
			pagination.innerHTML = "";

			const pageCount = Math.ceil(filteredRows.length / rowsPerPage);

			for (let i = 0; i < pageCount; i++) {
				const btn = document.createElement("button");
				btn.textContent = i + 1;
				btn.addEventListener("click", () => {
					// ê¸°ì¡´ í™œì„± ë²„íŠ¼ ì œê±°
					document.querySelectorAll('.pagination button').forEach(b => b.classList.remove('active'));
					// í´ë¦­ëœ ë²„íŠ¼ í™œì„±í™”
					btn.classList.add('active');
					showPage(i);
				});
				pagination.appendChild(btn);
			}

			// ì²« ë²ˆì§¸ í˜ì´ì§€ ë²„íŠ¼ í™œì„±í™”
			if (pagination.firstChild) {
				pagination.firstChild.classList.add('active');
			}
		}

		function loadQnaDetail(element) {
			const qnaId = element.getAttribute('data-id');

			fetch('/admin/qnaDetail/' + qnaId)
				.then(response => response.json())
				.then(qna => {
					document.getElementById("detail-id").textContent = qna.qnaId;
					document.getElementById("detail-title").textContent = qna.title;
					document.getElementById("detail-username").textContent = qna.username;
					document.getElementById("detail-regdate").textContent = qna.regdate;
					document.getElementById("detail-category").textContent = qna.category;
					document.getElementById("detail-status").textContent = qna.status;
					document.getElementById("detail-content").textContent = qna.content;
					document.getElementById("detail-answer").value = qna.answer;

					//ìƒì„¸ë³´ê¸° í¼ ë³´ì´ê¸°
					document.getElementById("qna-detail").style.display = "block";

					//ìŠ¤í¬ë¡¤ ì´ë™ (ì„ íƒ)
					document.getElementById("qna-detail").scrollIntoView({ behavior: "smooth" });
				})
				.catch(error => {
					console.error("QNA ìƒì„¸ë³´ê¸° ì‹¤íŒ¨:", error);
					alert("ìƒì„¸ë³´ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
				});
		}

		function submitAnswer() {
			const qnaId = document.getElementById("detail-id").textContent;
			const answer = document.getElementById("detail-answer").value;

			if (!answer.trim()) {
				alert("ë‹µë³€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
				return;
			}

			fetch('/admin/submitAnswer', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({ qnaId, answer })
			})
				.then(response => {
					if (!response.ok) throw new Error('ì„œë²„ ì˜¤ë¥˜');
					return response.json();
				})
				.then(updatedQna => {
					alert("ë‹µë³€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
					document.getElementById("detail-answer").value = updatedQna.answer;
					document.getElementById("detail-status").textContent = updatedQna.status;

					// í…Œì´ë¸” ë°˜ì˜
					const row = document.querySelector(`a[data-id="${qnaId}"]`).closest("tr");
					row.querySelector("td:nth-child(7)").textContent = updatedQna.status;
					row.querySelector("td:nth-child(6)").textContent = updatedQna.category;
				})
				.catch(error => {
					console.error("ë‹µë³€ ë“±ë¡ ì‹¤íŒ¨:", error);
					alert("ë‹µë³€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
				});
		}

		// ì•Œë¦¼ ë°°ë„ˆ ë¡œë“œ
		fetch('/admin/alertCount')
			.then(res => res.json())
			.then(count => {
				if (count > 0) {
					const banner = document.getElementById("alert-banner");
					const countSpan = document.getElementById("alert-count");
					countSpan.textContent = count;
					banner.style.display = "block";

					// ìë™ ì‚¬ë¼ì§
					setTimeout(() => {
						banner.style.display = "none";
					}, 10000);
				}
			})
			.catch(error => {
				console.error("ì•Œë¦¼ ì¹´ìš´íŠ¸ ë¡œë“œ ì‹¤íŒ¨:", error);
			});
	</script>

</body>
</html>